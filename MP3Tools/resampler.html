<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<title>MP3 Resampler</title>
<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
</head>
<body>
<h1>MP3 Resampler</h1>
<input type="file" id="audioFile" accept="audio/mpeg"><br><br>
<label>Target Sample Rate (Hz): </label>
<input type="number" id="sampleRate" value="44100"><br><br>
<button id="resampleBtn">Resample</button>
<p id="status"></p>

<script>
document.getElementById('resampleBtn').addEventListener('click', async () => {
  const fileInput = document.getElementById('audioFile');
  const sampleRate = parseInt(document.getElementById('sampleRate').value);
  const status = document.getElementById('status');

  if (!fileInput.files.length) {
    alert('Please select an MP3 file.');
    return;
  }
  if (!sampleRate || sampleRate <= 0) {
    alert('Please enter a valid sample rate.');
    return;
  }

  const file = fileInput.files[0];
  const arrayBuffer = await file.arrayBuffer();

  status.textContent = "Decoding audio...";
  const tempCtx = new AudioContext();
  const decodedData = await tempCtx.decodeAudioData(arrayBuffer);
  tempCtx.close();

  status.textContent = "Resampling...";
  const resampleCtx = new OfflineAudioContext(
    decodedData.numberOfChannels,
    decodedData.duration * sampleRate,
    sampleRate
  );

  const source = resampleCtx.createBufferSource();
  source.buffer = decodedData;
  source.connect(resampleCtx.destination);
  source.start(0);

  const renderedBuffer = await resampleCtx.startRendering();

  status.textContent = "Encoding MP3...";
  const mp3Blob = encodeToMp3(renderedBuffer);
  const url = URL.createObjectURL(mp3Blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `resampled_${sampleRate}Hz.mp3`;
  link.click();

  status.textContent = "Done!";
});

function encodeToMp3(audioBuffer) {
  const samples = audioBuffer.getChannelData(0);
  const sampleRate = audioBuffer.sampleRate;
  const mp3Encoder = new lamejs.Mp3Encoder(1, sampleRate, 128);
  const blockSize = 1152;
  const mp3Data = [];

  for (let i = 0; i < samples.length; i += blockSize) {
    const sampleChunk = samples.subarray(i, i + blockSize);
    const mp3buf = mp3Encoder.encodeBuffer(floatTo16BitPCM(sampleChunk));
    if (mp3buf.length > 0) mp3Data.push(mp3buf);
  }

  const end = mp3Encoder.flush();
  if (end.length > 0) mp3Data.push(end);

  return new Blob(mp3Data, { type: 'audio/mpeg' });
}

function floatTo16BitPCM(float32Array) {
  const buffer = new Int16Array(float32Array.length);
  for (let i = 0; i < float32Array.length; i++) {
    const s = Math.max(-1, Math.min(1, float32Array[i]));
    buffer[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
  }
  return buffer;
}
</script>

</body>
</html>
